<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="guestbook">
    <select id="findByLimitAndOffset" parameterType="map" resultType="boardvo">
        <![CDATA[
            select a.no ,  a.title  , a.contents , a.reg_date, a.o_no, a.depth , a.hit , b.no as user_no , b.name
            from board a ,user b
            where a.user_no = b.no
            order by a.g_no desc, a.o_no asc
            limit #{limit} offset #{offset}
        ]]>
    </select>
    <select id="searchWithKeywords" parameterType="map" resultType="boardvo">
        <![CDATA[
        select a.no, a.title, a.contents, a.reg_date, a.o_no, a.depth, a.hit, b.no AS user_no, b.name
        from board a, user b
        where a.user_no = b.no
        and (a.title like ? OR a.contents like ?)
        order by a.g_no desc , a.o_no asc
        limit ? offset ?
        ]]>
    </select>
    <select id="countTotalPosts" resultType="int">
        <![CDATA[
            select count(*) from board
        ]]>
    </select>
    <select id="countTotalPostsWithKeyword" parameterType="string" resultType="int">
        <![CDATA[
            select count(*)
            from board
            where title like #{title} or contents like #{contents}
        ]]>
    </select>
    <select id="findByNo" parameterType="long" resultType="boardvo">
        <![CDATA[
        select a.no, a.title, a.contents, a.reg_date, a.hit, a.g_no, a.o_no, a.depth, b.no, b.name
        from board a, user b
        where a.user_no = b.no
        and a.no = #{no}
        ]]>
    </select>
    <select id="findMaxGroupNo" resultType="int">
        select max(g_no) from board
    </select>
    <insert id="insert" parameterType="boardvo" >
        <![CDATA[
            insert into 
            board(title, contents, reg_date, hit, g_no, o_no, depth, user_no) 
            values(#{title}, #{contents}, now(), #{hit}, #{g_no}, #{o_no}, #{depth}, #{user_no})
        ]]>
        <selectKey keyProperty="no" resultType="long" order="AFTER">
            <![CDATA[
                select last_insert_id() from dual
            ]]>
        </selectKey>
    </insert>
    <update id="updateHit" parameterType="long">
        <![CDATA[
        update board set hit = hit + 1 where no = #{no}
        ]]>
    </update>
    <update id="modifyPost" parameterType="map">
        <![CDATA[
            update board set title = #{title}, contents = #{contents} where no = #{no}
        ]]>
    </update>
    <delete id="deleteByNo" parameterType="long">
        <![CDATA[
        delete from board where no = #{no}
        ]]>
    </delete>
    <update id="adjustOrderNo" parameterType="map">
        <![CDATA[
        update board set o_no = o_no + 1 where g_no = #{gNo} and o_no > #{oNo}
        ]]>
    </update>
</mapper>
